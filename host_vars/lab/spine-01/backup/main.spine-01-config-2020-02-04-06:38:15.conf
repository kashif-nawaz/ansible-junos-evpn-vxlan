
/* This block of configuration has been generated by the role overlay-evpn-qfx-l3 for Ansible */
routing-options {
    autonomous-system 65050;
    router-id 172.1.1.1;

    forwarding-table {
        ecmp-fast-reroute;
    }
}
protocols {
    bgp {
        group overlay {
            type internal;
            family evpn {
                signaling;
            }
            local-address 172.1.1.1;
            multipath;
            neighbor 172.1.1.6;
            neighbor 172.1.1.5;
            cluster 1.1.1.1;
            bfd-liveness-detection {
            minimum-interval 600;
            multiplier 3;
            session-mode automatic;
        }
     }
        group overlay-rr {
            type internal;
            family evpn {
                signaling;
            }
            family inet-vpn {
                unicast;
            }
            export pol-set-udp-encaps;
            vpn-apply-export;
            local-address 172.1.1.1;
            multipath;
            neighbor 172.1.1.2;
            bfd-liveness-detection {
            minimum-interval 600;
            multiplier 3;
            session-mode automatic;
        }
        }
        group contrail {
            type internal;
            local-address 172.1.1.1;
            family inet-vpn {
                unicast;
            }
            family evpn {
                signaling;
            }
            family inet6-vpn {
                unicast;
            }
            family route-target {
                external-paths 255;
                advertise-default;
            }
            export [ nhs pol-set-udp-encaps ];
            vpn-apply-export;
            cluster 1.1.1.2;
            no-client-reflect;
            neighbor 192.168.254.12 {
                description "Contrail-Controller";
            }
            neighbor 192.168.254.13 {
                description "Contrail-Controller";
            }
        }

		
 }
}

routing-options {

   rib inet.3 {
        static {
            route 192.168.254.0/24 discard;
        }
    }
   dynamic-tunnels {
        OVERLAY {
            source-address 172.1.1.1;
            udp;
            destination-networks {
                192.168.254.0/24;
                172.1.1.2;
            }
        }
    }
}

interfaces {
xe-0/0/3 {
    unit 0 {
        family mpls;
          }
    }
xe-0/0/1 {
    unit 0 {
        family mpls;
          }
    }
xe-0/0/2 {
    unit 0 {
        family mpls;
          }
    }
xe-0/0/0 {
    unit 0 {
        family mpls;
          }
    }
}
protocols {
 mpls {
        interface xe-0/0/3.0;
        interface xe-0/0/1.0;
        interface xe-0/0/2.0;
        interface xe-0/0/0.0;
    }
}

policy-options {
policy-statement nhs {
        term 1 {
            from family inet-vpn;
            then {
                next-hop self;
            }
        }
        term 2 {
            from family inet6-vpn;
            then {
                next-hop self;
            }
        }
    }
    policy-statement pol-set-udp-encaps {
        term inet-vpn {
            from family inet-vpn;
            then {
                community add com-encaps-udp;
                accept;
            }
        }
        term inet6-vpn {
            from family inet6-vpn;
            then {
                community add com-encaps-udp;
                accept;
            }
        }
    }
community com-encaps-udp members 0x030c:65050:13; 
}
/* This block of configuration has been generated by the role overlay-evpn-qfx-l3 for Ansible */


routing-instances {
   vrf_sriov_1001 {
        instance-type vrf;
        interface irb.1001;
        interface xe-0/0/4.2001;
        route-distinguisher 172.1.1.1:1001;
        vrf-import vrf_sriov_1001_import;
        vrf-export vrf_sriov_1001_export;
        vrf-table-label;
        routing-options {
             auto-export;
        }
        protocols {
        bgp {
        group to-nc21 {
            export vrf_sriov_1001_nc21_export;
            remove-private;
            peer-as 54321;
            local-as 12345;
            local-as loops 2;
            neighbor 10.255.1.1;
            }
        }
        evpn {
            ip-prefix-routes {
                advertise direct-nexthop;
                encapsulation vxlan;
                vni 2002;
            }
        }
    }
  }
   vrf_sriov_1002 {
        instance-type vrf;
        interface irb.1002;
        interface xe-0/0/4.2002;
        route-distinguisher 172.1.1.1:1002;
        vrf-import vrf_sriov_1002_import;
        vrf-export vrf_sriov_1002_export;
        vrf-table-label;
        routing-options {
             auto-export;
        }
        protocols {
        bgp {
        group to-nc21 {
            export vrf_sriov_1002_nc21_export;
            remove-private;
            peer-as 54321;
            local-as 12345;
            local-as loops 2;
            neighbor 10.255.1.1;
            }
        }
        evpn {
            ip-prefix-routes {
                advertise direct-nexthop;
                encapsulation vxlan;
                vni 2004;
            }
        }
    }
  }
}


interfaces {

  xe-0/0/4 {
      description "xe-0/0/4_nc_21";
      vlan-tagging;
      unit 2001 {
           description "vrf_sriov_1001_nc_21";
          vlan-id 2001;
          family inet {
              address 10.255.1.0/31;
          }
      }
  }

    irb {
        mtu 9100;
        replace:
        unit 1001 {
            proxy-macip-advertisement;
            virtual-gateway-accept-data;
            family inet {    
                address 192.168.111.3/24 {
                    virtual-gateway-address 192.168.111.1;
                }
            }
            virtual-gateway-v4-mac 00:a0:a0:a0:00:a0;
        }
    }

  xe-0/0/4 {
      description "xe-0/0/4_nc_21";
      vlan-tagging;
      unit 2002 {
           description "vrf_sriov_1002_nc_21";
          vlan-id 2002;
          family inet {
              address 10.255.1.0/31;
          }
      }
  }

    irb {
        mtu 9100;
        replace:
        unit 1002 {
            proxy-macip-advertisement;
            virtual-gateway-accept-data;
            family inet {    
                address 192.168.112.3/24 {
                    virtual-gateway-address 192.168.112.1;
                }
            }
            virtual-gateway-v4-mac 00:a0:a0:a0:00:a0;
        }
    }
}


 protocols {
    evpn {
       vni-options {
           vni 1001 {
               vrf-target target:65050:1001;
           }
           vni 1002 {
               vrf-target target:65050:1002;
           }
      }
       encapsulation vxlan;
       multicast-mode ingress-replication;
       remote-ip-host-routes;
       default-gateway no-gateway-community;
       extended-vni-list [ 1001  1002 ];
   }
 }
 switch-options {
      vtep-source-interface lo0.0;
      route-distinguisher 172.1.1.1:1;
      vrf-import pl-leaf-in;
      vrf-target target:9999:9999;
  }
 replace:
 vlans {
       sriov_1001 {
            vlan-id 1001;
            l3-interface irb.1001;
            vxlan {
                vni 1001;
               }
           }
       sriov_1002 {
            vlan-id 1002;
            l3-interface irb.1002;
            vxlan {
                vni 1002;
               }
           }
       }
policy-options {
 policy-statement pl-leaf-in {
       term sw-comm {
            from community CM-LEAF-ESI;
            then accept;
        }
        term import_vni_1001 {
            from community target:65050:1001;
            then accept;
        }
        term import_vni_1002 {
            from community target:65050:1002;
            then accept;
        }
        term last-term {
            then reject;
        }
}
}



policy-options {

    policy-statement vrf_sriov_1001_nc21_export {
        term 1 {
            from {
               route-filter 192.168.111.0/24 exact;
                }
               then accept;
        }
    }

    policy-statement vrf_sriov_1001_export {
        term 1 {
            then {
                community add vrf_sriov_1001;
                accept;
            }
        }
    }
    policy-statement vrf_sriov_1001_import {
        term 1 {
            from community vrf_sriov_1001;
            then accept;
        }
    }

  policy-statement vrf_sriov_1002_import {
    term vrf_sriov_1001_vrf_sriov_1002 {
       from {
        community vrf_sriov_1001;
        route-filter 192.168.111.0/24 longer;
       }
        then accept;
   }
  }
  policy-statement vrf_sriov_1003_import {
    term vrf_sriov_1001_vrf_sriov_1003 {
       from {
        community vrf_sriov_1001;
        route-filter 192.168.111.0/24 longer;
       }
        then accept;
   }
  }
  policy-statement vrf_nc_commm_test_import {
    term vrf_sriov_1001_vrf_nc_commm_test {
       from {
        community vrf_sriov_1001;
        route-filter 192.168.111.0/24 longer;
       }
        then accept;
   }
  }
  policy-statement vrf_nc_commm_mgmt_import {
    term vrf_sriov_1001_vrf_nc_commm_mgmt {
       from {
        community vrf_sriov_1001;
        route-filter 192.168.111.0/24 longer;
       }
        then accept;
   }
  }


    policy-statement vrf_sriov_1002_nc21_export {
        term 1 {
            from {
               route-filter 192.168.112.0/24 exact;
                }
               then accept;
        }
    }

    policy-statement vrf_sriov_1002_export {
        term 1 {
            then {
                community add vrf_sriov_1002;
                accept;
            }
        }
    }
    policy-statement vrf_sriov_1002_import {
        term 1 {
            from community vrf_sriov_1002;
            then accept;
        }
    }

  policy-statement vrf_sriov_1001_import {
    term vrf_sriov_1002_vrf_sriov_1001 {
       from {
        community vrf_sriov_1002;
        route-filter 192.168.112.0/24 longer;
       }
        then accept;
   }
  }


  community CM-LEAF-ESI members target:9999:9999;
  community target:65050:1001 members target:65050:1001;
  community vrf_sriov_1001 members target:65050:1001;
  community target:65050:1002 members target:65050:1002;
  community vrf_sriov_1002 members target:65050:1002;

}

class-of-service {
    interfaces {
        xe-0/0/4 {
            unit 2001 {
                rewrite-rules {
                    dscp CUST-BT-AF21;
                }
            }
        }
    }
    rewrite-rules {
        dscp CUST-BT-AF21 {
            forwarding-class best-effort {
                loss-priority low code-point 010010;
            }
        }
    }
}

routing-instances {
    vrf_sriov_1002 {
	routing-options {
	  aggregate {
	      route 192.168.111.0/24;
		   }
	      }
	}
}
routing-instances {
    vrf_sriov_1003 {
	routing-options {
	  aggregate {
	      route 192.168.111.0/24;
		   }
	      }
	}
}
routing-instances {
    vrf_nc_commm_test {
	routing-options {
	  aggregate {
	      route 192.168.111.0/24;
		   }
	      }
	}
}
routing-instances {
    vrf_nc_commm_mgmt {
	routing-options {
	  aggregate {
	      route 192.168.111.0/24;
		   }
	      }
	}
}
routing-instances {
    vrf_sriov_1001 {
	routing-options {
	  aggregate {
	      route 192.168.112.0/24;
		   }
	      }
	}
}


interfaces {
  xe-0/0/4 {
      description "xe-0/0/4_nc_21";
      vlan-tagging;
      unit 2004 {
          description "vrf_nc_commm_test_nc_21";
          vlan-id 2004;
          family inet {
              address 10.255.1.0/31;
          }
      }
  }
  }
 policy-options {
  policy-statement vrf_nc_commm_test_nc21_export {
    term 1 {
      from {
          route-filter 192.168.200.0/24 exact;
      }
      then accept;
  }
  }
  policy-statement vrf_nc_commm_test_export {
    term 1 {
        then {
            community add nc_commm_test;
            accept;
        }
    }
 }
  policy-statement vrf_nc_commm_test_import {
    term 1 {
        from community nc_commm_test;
        then accept;
    }
  }
  community nc_commm_test members target:65050:2004;
 }
 routing-instances {
      vrf_nc_commm_test {
        instance-type vrf;
        interface xe-0/0/4.2004;
        route-distinguisher 172.1.1.1:2004;
        vrf-import vrf_nc_commm_test_import;
        vrf-export vrf_nc_commm_test_export;
        vrf-table-label;
        routing-options {
             auto-export;
        }
        protocols {
        bgp {
        group to-nc21 {
            export vrf_nc_commm_test_nc21_export;
            remove-private;
            peer-as 54321;
            local-as 12345;
            local-as loops 2;
            neighbor 10.255.1.1;
            }
        }
    }
  }
 }


class-of-service {
    interfaces {
        xe-0/0/4 {
            unit 2004 {
                rewrite-rules {
                    dscp CUST-BT-AF22;
                }
            }
        }
    }
    rewrite-rules {
        dscp CUST-BT-AF22 {
            forwarding-class best-effort {
                loss-priority low code-point 010011;
            }
        }
    }
}

policy-options {
  policy-statement vrf_sriov_1001_import {
    term vrf_nc_commm_test_vrf_sriov_1001 {
       from {
        community nc_commm_test;
        route-filter 192.168.200.0/24 longer;
       }
        then accept;
   }
  }
}

  routing-instances {
    vrf_sriov_1001 {
           routing-options {
	      aggregate {
		route 192.168.200.0/24;
			}
		}
	}
   }
 


interfaces {
  xe-0/0/4 {
      description "xe-0/0/4_nc_21";
      vlan-tagging;
      unit 2005 {
          description "vrf_nc_commm_mgmt_nc_21";
          vlan-id 2005;
          family inet {
              address 10.255.1.0/31;
          }
      }
  }
  }
 policy-options {
  policy-statement vrf_nc_commm_mgmt_nc21_export {
    term 1 {
      from {
          route-filter 192.168.201.0/24 exact;
      }
      then accept;
  }
  }
  policy-statement vrf_nc_commm_mgmt_export {
    term 1 {
        then {
            community add nc_commm_mgmt;
            accept;
        }
    }
 }
  policy-statement vrf_nc_commm_mgmt_import {
    term 1 {
        from community nc_commm_mgmt;
        then accept;
    }
  }
  community nc_commm_mgmt members target:65050:2005;
 }
 routing-instances {
      vrf_nc_commm_mgmt {
        instance-type vrf;
        interface xe-0/0/4.2005;
        route-distinguisher 172.1.1.1:2005;
        vrf-import vrf_nc_commm_mgmt_import;
        vrf-export vrf_nc_commm_mgmt_export;
        vrf-table-label;
        routing-options {
             auto-export;
        }
        protocols {
        bgp {
        group to-nc21 {
            export vrf_nc_commm_mgmt_nc21_export;
            remove-private;
            peer-as 54321;
            local-as 12345;
            local-as loops 2;
            neighbor 10.255.1.1;
            }
        }
    }
  }
 }



policy-options {
  policy-statement vrf_sriov_1001_import {
    term vrf_nc_commm_mgmt_vrf_sriov_1001 {
       from {
        community nc_commm_mgmt;
        route-filter 192.168.201.0/24 longer;
       }
        then accept;
   }
  }
}

  routing-instances {
    vrf_sriov_1001 {
           routing-options {
	      aggregate {
		route 192.168.201.0/24;
			}
		}
	}
   }
 





/* This block of configuration has been generated by the role underlay-ebgp for Ansible */

groups {
    GR-CORE-INTF {
        interfaces {
            <*> {
                traps;
                mtu 9216;
                hold-time up 5000 down 0;
               
            }
        }
    }
    GR-EDGE-INTF {
        interfaces {
            <*> {
                traps;
                mtu 9118;
                hold-time up 5000 down 0;
            }
			<ae*> {
                aggregated-ether-options {
                    lacp {
                        active;
                        periodic fast;
                    }
                }
            }
			
        }
    }
}

interfaces {
       replace:
    xe-0/0/3 {
         apply-groups GR-CORE-INTF;
        description " * to leaf-02";
        unit 0 {
            family inet {
                address 100.0.1.6/31;
            }
           family mpls;
        }
    }
       replace:
    xe-0/0/1 {
         apply-groups GR-CORE-INTF;
        description " * to spine-02";
        unit 0 {
            family inet {
                address 100.0.1.2/31;
            }
           family mpls;
        }
    }
       replace:
    xe-0/0/2 {
         apply-groups GR-CORE-INTF;
        description " * to leaf-01";
        unit 0 {
            family inet {
                address 100.0.1.4/31;
            }
           family mpls;
        }
    }
       replace:
    xe-0/0/0 {
         apply-groups GR-CORE-INTF;
        description " * to spine-02";
        unit 0 {
            family inet {
                address 100.0.1.0/31;
            }
           family mpls;
        }
    }
lo0 {
    unit 0 {
        family inet {
            address 172.1.1.1;
        }
    }
}
}

protocols {
    replace:
    bgp {
        log-updown;
        graceful-restart;
        group underlay {
            export  bgp-ipclos-out;
            type external;
            mtu-discovery;
            local-as 65000;
            multipath multiple-as;
            neighbor 100.0.1.7 {
                peer-as 65003;
            }
            neighbor 100.0.1.3 {
                peer-as 65001;
            }
            neighbor 100.0.1.5 {
                peer-as 65002;
            }
            neighbor 100.0.1.1 {
                peer-as 65001;
            }
        }
    }
}

routing-options {
    router-id 172.1.1.1;
    forwarding-table {
        export pfe-ecmp;
    }
}

policy-options {
    policy-statement pfe-ecmp {
        then {
            load-balance per-packet;
        }
    }


    policy-statement bgp-ipclos-out {
        term loopback {
            from {
                route-filter 172.1.1.0/24 orlonger;
            }
            then {
                accept;
            }
        }
    }

}

